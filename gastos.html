<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Gastos — RCV</title>

  <link rel="stylesheet" href="css/estilos.css">

  <!-- (Se elimina el script que forzaba API_BASE=localhost) -->

  <script src="js/topbar.js" defer></script>
  <script src="js/logout.js" defer></script>
  <script src="js/theme.js" defer></script>
  <script src="js/toast.js" defer></script>
</head>
<body data-page-key="gastos-admin">
  <div id="topbarContainer"></div>

  <main class="container container--fluid">
    <h1>Gastos</h1>

    <!-- FILTROS -->
    <section class="card">
      <div class="toolbar">
        <div class="field">
          <label>Desde</label>
          <input id="f_desde" type="date" />
        </div>
        <div class="field">
          <label>Hasta</label>
          <input id="f_hasta" type="date" />
        </div>
        <div class="field">
          <label>Categoría</label>
          <input id="f_categoria" placeholder="Ej: Servicios, Equipo…" />
        </div>
        <div class="field">
          <label>Proveedor</label>
          <input id="f_proveedor" placeholder="Opcional" />
        </div>
        <div class="actions" style="margin-left:auto">
          <button class="btn" id="btnBuscar">Buscar</button>
          <button class="btn btn-ghost" id="btnNuevo">+ Nuevo gasto</button>
        </div>
      </div>
      <div class="muted" id="hintFiltro" style="margin-top:6px">Filtra por fechas/categoría si lo necesitás.</div>
    </section>

    <!-- LISTA -->
    <section class="card">
      <div class="table-scroll">
        <table class="tabla" id="tabGastos">
          <thead>
            <tr>
              <th>Fecha</th>
              <th>Categoría</th>
              <th>Proveedor</th>
              <th>Descripción</th>
              <th class="ta-r">Monto</th>
              <th>Adjunto</th>
              <th style="width:100px">Acciones</th>
            </tr>
          </thead>
          <tbody>
            <tr><td colspan="7">Cargando…</td></tr>
          </tbody>
          <tfoot>
            <tr>
              <td colspan="4" class="ta-r"><strong>Total:</strong></td>
              <td class="ta-r"><strong id="ft_total">L 0.00</strong></td>
              <td colspan="2"></td>
            </tr>
          </tfoot>
        </table>
      </div>
    </section>
  </main>

  <!-- MODAL NUEVO/EDITAR -->
  <dialog id="dlgGasto" style="width:min(800px,96vw);border:none;border-radius:12px;padding:0;box-shadow:var(--shadow)">
    <div class="card" style="margin:0;border:none;box-shadow:none">
      <div class="card-header">
        <h2 id="dlgTitle" style="margin:0">Nuevo gasto</h2>
        <div class="toolbar">
          <button class="btn-ghost" id="btnCerrarDlg" type="button">Cerrar</button>
        </div>
      </div>

      <form id="formGasto" class="grid-2" style="padding:8px 12px 16px 12px">
        <input type="hidden" id="g_id" />
        <div class="field">
          <label>Fecha *</label>
          <input id="g_fecha" type="date" required />
        </div>
        <div class="field">
          <label>Categoría *</label>
          <input id="g_categoria" placeholder="Servicios, Equipo, Rentas, Utilidades…" required />
        </div>
        <div class="field full">
          <label>Descripción *</label>
          <input id="g_descripcion" required />
        </div>
        <div class="field">
          <label>Proveedor</label>
          <input id="g_proveedor" placeholder="Opcional" />
        </div>
        <div class="field">
          <label>Monto (L) *</label>
          <input id="g_monto" type="number" step="0.01" required />
        </div>
        <div class="field full">
          <label>Adjunto (foto/PNG/JPG/PDF) — opcional</label>
          <input id="g_adjunto" type="file" accept=".png,.jpg,.jpeg,.pdf,image/png,image/jpeg,application/pdf" />
          <small class="muted">Si tu API soporta subida multiparte, se enviará el archivo como <code>foto</code>. Si no, puedes pegar manualmente una URL:</small>
          <input id="g_adjunto_url" placeholder="o pega aquí una URL directa al adjunto (opcional)" />
        </div>

        <div class="actions full" style="margin-top:8px">
          <button class="btn-primary" id="btnGuardarGasto" type="submit">Guardar</button>
          <button class="btn" id="btnCancelarGasto" type="button">Cancelar</button>
        </div>
      </form>
    </div>
  </dialog>

  <script src="js/gastos.js"></script>

  <script>
    (function guard() {
      try {
        const raw = localStorage.getItem('usuarioActual');
        if (!raw) { localStorage.setItem('paginaDestino', 'gastos.html'); location.href = 'login.html'; }
      } catch {}
    })();
  </script>
</body>
</html>
