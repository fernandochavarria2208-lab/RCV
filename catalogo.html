<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Catálogo (Servicios / Repuestos) — RCV</title>

  <link rel="stylesheet" href="css/estilos.css">

  <script>
    (function(){
      try{
        if(!localStorage.getItem('API_BASE')){
          localStorage.setItem('API_BASE','http://localhost:3001/api');
        }
      }catch(e){}
    })();
  </script>

  <!-- base del proyecto como en clientes -->
  <script src="js/topbar.js" defer></script>
  <script src="js/logout.js" defer></script>
  <script src="js/theme.js" defer></script>
  <script src="js/toast.js" defer></script>
</head>
<body data-page-key="catalogo-admin">
  <div id="topbarContainer"></div>

  <main class="container container--fluid">
    <h1>Catálogo (Servicios / Repuestos)</h1>

    <!-- FILTROS -->
    <section class="card">
      <div class="toolbar">
        <div class="field">
          <label>Buscar</label>
          <input id="f_search" placeholder="nombre o SKU" />
        </div>
        <div class="field">
          <label>Tipo</label>
          <select id="f_tipo">
            <option value="">Todos</option>
            <option value="servicio">Servicio</option>
            <option value="repuesto">Repuesto</option>
            <option value="producto">Producto</option>
          </select>
        </div>
        <div class="field" id="boxSeccion">
          <label>Sección (servicio)</label>
          <select id="f_seccion"></select>
        </div>
        <div class="field" id="boxArea" style="display:none">
          <label>Área vehículo (repuesto)</label>
          <select id="f_area"></select>
        </div>
        <div class="field">
          <label>Límite</label>
          <select id="f_limit">
            <option>20</option><option selected>50</option><option>100</option>
          </select>
        </div>
        <div class="actions" style="margin-left:auto">
          <button class="btn" id="btnReload">Actualizar</button>
          <button class="btn btn-ghost" id="btnNew">+ Nuevo</button>
        </div>
      </div>
      <div class="muted" id="hintFiltro" style="margin-top:6px">Mostrando: todos.</div>
    </section>

    <!-- LISTA -->
    <section class="card">
      <div class="table-scroll">
        <table class="tabla" id="tabCat">
          <thead>
            <tr>
              <th>ID</th><th>SKU</th><th>Nombre</th><th>Tipo</th><th>Sección/Área</th>
              <th>Unidad</th><th>Precio final</th><th>Impuesto %</th><th>Activo</th>
              <th style="width:90px">Acciones</th>
            </tr>
          </thead>
          <tbody><tr><td colspan="10">Cargando…</td></tr></tbody>
        </table>
      </div>
    </section>
  </main>

  <!-- OVERLAY + DRAWER (mismo patrón de clientes/usuarios) -->
  <div id="drawerOverlay" class="drawer-overlay" hidden></div>
  <aside id="drawerCat" class="drawer" aria-hidden="true">
    <div class="drawer-header">
      <strong class="drawer-title">Editar ítem</strong>
      <button class="drawer-close btn-ghost" id="btnCloseDrawer" aria-label="Cerrar panel">Cerrar</button>
    </div>

    <div class="drawer-body">
      <form id="formEdit" class="grid-2" novalidate>
        <input type="hidden" id="e_id" />
        <div class="field full">
          <label>Nombre *</label>
          <input id="e_nombre" required />
        </div>
        <div class="field">
          <label>SKU</label>
          <input id="e_sku" />
        </div>
        <div class="field">
          <label>Tipo *</label>
          <select id="e_tipo" required>
            <option value="servicio">Servicio</option>
            <option value="repuesto">Repuesto</option>
            <option value="producto">Producto</option>
          </select>
        </div>
        <div class="field" id="e_boxSeccion">
          <label>Sección *</label>
          <select id="e_seccion"></select>
        </div>
        <div class="field" id="e_boxArea" style="display:none">
          <label>Área *</label>
          <select id="e_area"></select>
        </div>
        <div class="field">
          <label>Unidad</label>
          <input id="e_unidad" value="unidad" />
        </div>
        <div class="field">
          <label>Precio final *</label>
          <input id="e_precio" type="number" step="0.01" required />
        </div>
        <div class="field">
          <label>Impuesto %</label>
          <input id="e_impuesto" type="number" step="0.01" value="0" />
        </div>
        <div class="field">
          <label>Activo</label>
          <select id="e_activo"><option value="1">Sí</option><option value="0">No</option></select>
        </div>
        <div class="actions full" style="margin-top:12px">
          <button class="btn-primary" id="btnSaveEdit" type="submit">Guardar</button>
          <button class="btn" id="btnCancelEdit" type="button">Cancelar</button>
        </div>
      </form>
    </div>
  </aside>

  <!-- MODAL NUEVO (card como clientes) -->
  <dialog id="dlgNew" style="width:min(860px,96vw);border:none;border-radius:12px;padding:0;box-shadow:var(--shadow)">
    <div class="card" style="margin:0;border:none;box-shadow:none">
      <div class="card-header">
        <h2 style="margin:0">Nuevo ítem</h2>
        <div class="toolbar">
          <button class="btn-ghost" id="btnCancelNew" type="button">Cerrar</button>
        </div>
      </div>
      <form id="formNew" class="grid-2" style="padding:8px 12px 16px 12px" novalidate>
        <div class="field full">
          <label>Nombre *</label>
          <input id="n_nombre" required />
        </div>
        <div class="field">
          <label>SKU</label>
          <input id="n_sku" />
        </div>
        <div class="field">
          <label>Tipo *</label>
          <select id="n_tipo" required>
            <option value="servicio">Servicio</option>
            <option value="repuesto">Repuesto</option>
            <option value="producto">Producto</option>
          </select>
        </div>
        <div class="field" id="n_boxSeccion">
          <label>Sección *</label>
          <select id="n_seccion"></select>
          <button class="btn btn-sm" id="btnAddSeccion" type="button" style="margin-top:6px">+ agregar sección</button>
        </div>
        <div class="field" id="n_boxArea" style="display:none">
          <label>Área *</label>
          <select id="n_area"></select>
          <button class="btn btn-sm" id="btnAddArea" type="button" style="margin-top:6px">+ agregar área</button>
        </div>
        <div class="field">
          <label>Unidad</label>
          <input id="n_unidad" value="unidad" />
        </div>
        <div class="field">
          <label>Precio final *</label>
          <input id="n_precio" type="number" step="0.01" required />
        </div>
        <div class="field">
          <label>Impuesto %</label>
          <input id="n_impuesto" type="number" step="0.01" value="0" />
        </div>
        <div class="actions full" style="margin-top:8px">
          <button class="btn-primary" id="btnSaveNew" type="submit">Guardar</button>
          <button class="btn" id="btnCancelNewFooter" type="button">Cancelar</button>
        </div>
      </form>
    </div>
  </dialog>

  <!-- MODAL VER (card como clientes) -->
  <dialog id="dlgView" style="width:min(820px,96vw);border:none;border-radius:12px;padding:0;box-shadow:var(--shadow)">
    <div class="card" style="margin:0;border:none;box-shadow:none">
      <div class="card-header">
        <h2 style="margin:0">Detalle</h2>
        <div class="toolbar">
          <button class="btn-ghost" id="btnCloseView" type="button">Cerrar</button>
        </div>
      </div>
      <div id="viewBody" class="muted" style="max-height:65vh;overflow:auto;padding:8px 12px 16px 12px"></div>
    </div>
  </dialog>

  <!-- Lógica -->
  <script src="js/catalogo.js"></script>

  <script>
    (function guard(){
      try {
        const raw = localStorage.getItem('usuarioActual');
        if (!raw) { localStorage.setItem('paginaDestino','catalogo.html'); location.href='login.html'; }
      } catch {}
    })();
  </script>
</body>
</html>
